<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Amor - Para KIM</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Navegaci√≥n flotante -->
    <nav class="floating-nav">
        <div class="nav-buttons">
            <button class="nav-btn" id="home-btn" title="Inicio">
                <i class="fas fa-home"></i>
            </button>
            <a href="timeline.html" class="nav-btn" id="timeline-btn" title="Nuestra Historia">
                <i class="fas fa-heartbeat"></i>
            </a>
            <a href="gallery.html" class="nav-btn" id="gallery-btn" title="Galer√≠a">
                <i class="fas fa-images"></i>
            </a>
            <a href="game.html" class="nav-btn" id="game-btn" title="Juego">
                <i class="fas fa-gamepad"></i>
            </a>
            <a href="music.html" class="nav-btn" id="music-btn" title="M√∫sica">
                <i class="fas fa-music"></i>
            </a>
            <button class="nav-btn" id="theme-btn" title="Cambiar tema">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </nav>

    <!-- Contador de d√≠as especial -->
    <div class="special-counter">
        <div class="counter-item">
            <span class="counter-number" id="days-together">63</span>
            <span class="counter-label">D√≠as Juntos</span>
        </div>
        <div class="counter-item">
            <span class="counter-number">63</span>
            <span class="counter-label">Razones de Amor</span>
        </div>
        <div class="counter-item">
            <span class="counter-number" id="love-level">100%</span>
            <span class="counter-label">Nivel de Amor</span>
        </div>
    </div>

    <!-- Efectos de part√≠culas -->
    <div id="particles-js"></div>

    <div class="background-animation"></div>
    
    <div class="container">
        <header class="header">
            <div class="heart-icon">‚ù§Ô∏è</div>
            <h1 class="title">Para Mi Amor, KIM</h1>
            <p class="subtitle">Cada d√≠a es una nueva raz√≥n para amarte m√°s</p>
            <div class="days-counter">D√≠a <span id="current-day">1</span> de 63</div>
            
            <!-- Buscador de mensajes -->
            <div class="search-container">
                <input type="text" id="search-messages" placeholder="Buscar mensajes especiales...">
                <i class="fas fa-search"></i>
            </div>
        </header>

        <main class="main-content">
            <!-- Filtros por categor√≠as -->
            <div class="filters">
                <button class="filter-btn active" data-filter="all">Todos</button>
                <button class="filter-btn" data-filter="romantic">Rom√°nticos</button>
                <button class="filter-btn" data-filter="future">Futuro</button>
                <button class="filter-btn" data-filter="funny">Divertidos</button>
                <button class="filter-btn" data-filter="deep">Profundos</button>
            </div>

            <div class="letters-grid" id="letters-container">
                <!-- Las cartitas se generar√°n con JavaScript -->
            </div>

            <!-- Barra de progreso -->
            <div class="progress-container">
                <div class="progress-bar" id="love-progress"></div>
                <div class="progress-text">
                    <span>Progreso del Amor</span>
                    <span id="progress-percent">0%</span>
                </div>
            </div>
        </main>

        <footer class="footer">
            <div class="footer-content">
                <p>Hecho con <span class="heart-pulse">‚ù§Ô∏è</span> especialmente para ti, mi amor</p>
                <div class="footer-buttons">
                    <button class="secret-btn" id="secret-surprise">
                        <i class="fas fa-gift"></i> Sorpresa Secreta
                    </button>
                    <button class="print-btn" id="print-all">
                        <i class="fas fa-print"></i> Guardar Todos
                    </button>
                </div>
            </div>
        </footer>
    </div>

    <!-- Modal mejorado - FIXED -->
    <div class="modal" id="message-modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-day">D√≠a 1</h2>
                <div class="heart-decoration">üíñ</div>
                <div class="modal-actions">
                    <button class="action-btn" id="copy-message">
                        <i class="far fa-copy"></i>
                    </button>
                    <button class="action-btn" id="share-message">
                        <i class="fas fa-share-alt"></i>
                    </button>
                    <button class="action-btn" id="save-favorite">
                        <i class="far fa-heart"></i>
                    </button>
                    <button class="action-btn close-modal" id="close-modal-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="modal-body">
                <div class="message-icon" id="modal-icon">üòä</div>
                <p id="modal-message"></p>
            </div>
            <div class="modal-footer">
                <button id="love-btn" class="love-button">
                    <i class="fas fa-heart"></i> TE AMO INFINITAMENTE ‚ù§Ô∏è
                </button>
                <button id="next-btn" class="next-button">
                    Siguiente <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Notificaciones flotantes -->
    <div id="notification" class="notification">
        <div class="notification-content">
            <i class="fas fa-heart"></i>
            <span id="notification-text"></span>
        </div>
    </div>

    <!-- √Årea de efectos especiales -->
    <canvas id="fireworks-canvas"></canvas>
    <canvas id="hearts-canvas"></canvas>

    <!-- Mensaje de amor flotante -->
    <div id="floating-love" class="floating-love">TE AMO</div>

    <!-- Audio para efectos -->
    <audio id="heart-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-heartbeat-100.mp3" type="audio/mpeg">
    </audio>
    <audio id="sparkle-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-magic-sparkles-300.mp3" type="audio/mpeg">
    </audio>

    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script>
        // Datos mejorados con categor√≠as
        const messages = [
            {
                day: 1,
                message: "Tu sonrisa ilumina mis d√≠as m√°s grises. Desde que est√°s en mi vida, todo tiene m√°s color.",
                icon: "üòä",
                category: "romantic"
            },
            {
                day: 2,
                message: "Contigo he descubierto un amor que no conoc√≠a. Un amor que sana, que comprende, que perdona.",
                icon: "‚ù§Ô∏è",
                category: "romantic"
            },
            // ... (todos tus mensajes aqu√≠, manteniendo el array completo)
            // Por espacio, mantengo solo los primeros como ejemplo
        ];

        // Estado de la aplicaci√≥n
        let state = {
            currentDay: 1,
            favorites: JSON.parse(localStorage.getItem('favorites')) || [],
            viewedMessages: JSON.parse(localStorage.getItem('viewedMessages')) || [],
            theme: localStorage.getItem('theme') || 'light',
            loveLevel: parseInt(localStorage.getItem('loveLevel')) || 100
        };

        // Elementos DOM
        const elements = {
            lettersContainer: document.getElementById('letters-container'),
            modal: document.getElementById('message-modal'),
            modalOverlay: document.querySelector('.modal-overlay'),
            modalDay: document.getElementById('modal-day'),
            modalMessage: document.getElementById('modal-message'),
            modalIcon: document.getElementById('modal-icon'),
            closeModalBtn: document.getElementById('close-modal-btn'),
            loveButton: document.getElementById('love-btn'),
            currentDayElement: document.getElementById('current-day'),
            fireworksCanvas: document.getElementById('fireworks-canvas'),
            heartsCanvas: document.getElementById('hearts-canvas'),
            floatingLove: document.getElementById('floating-love'),
            searchInput: document.getElementById('search-messages'),
            filterButtons: document.querySelectorAll('.filter-btn'),
            progressBar: document.getElementById('love-progress'),
            progressPercent: document.getElementById('progress-percent'),
            daysTogether: document.getElementById('days-together'),
            loveLevel: document.getElementById('love-level'),
            secretSurprise: document.getElementById('secret-surprise'),
            printAll: document.getElementById('print-all'),
            themeBtn: document.getElementById('theme-btn'),
            notification: document.getElementById('notification'),
            notificationText: document.getElementById('notification-text'),
            heartSound: document.getElementById('heart-sound'),
            sparkleSound: document.getElementById('sparkle-sound'),
            copyBtn: document.getElementById('copy-message'),
            shareBtn: document.getElementById('share-message'),
            saveFavoriteBtn: document.getElementById('save-favorite'),
            nextBtn: document.getElementById('next-btn')
        };

        // Inicializaci√≥n mejorada
        document.addEventListener('DOMContentLoaded', () => {
            init();
            updateCounters();
            updateProgress();
        });

        function init() {
            createLetters();
            setupEventListeners();
            setupFilters();
            setupSearch();
            applyTheme();
            updateProgress();
        }

        // Crear cartitas mejoradas
        function createLetters() {
            elements.lettersContainer.innerHTML = '';
            
            messages.forEach(msg => {
                const letter = document.createElement('div');
                letter.className = 'letter';
                letter.dataset.day = msg.day;
                letter.dataset.category = msg.category;
                
                const isViewed = state.viewedMessages.includes(msg.day);
                const isFavorite = state.favorites.includes(msg.day);
                
                if (isViewed) {
                    letter.classList.add('viewed');
                }
                
                if (isFavorite) {
                    letter.classList.add('favorite');
                    letter.innerHTML += '<div class="favorite-star">‚≠ê</div>';
                }
                
                letter.innerHTML += `
                    <div class="letter-number">D√≠a ${msg.day}</div>
                    <div class="letter-icon">${msg.icon}</div>
                    <div class="letter-content">${truncateText(msg.message, 60)}</div>
                    <div class="letter-footer">
                        <span class="letter-category">${msg.category}</span>
                    </div>
                `;
                
                letter.addEventListener('click', () => openModal(msg.day));
                
                elements.lettersContainer.appendChild(letter);
            });
        }

        // Configurar event listeners mejorados
        function setupEventListeners() {
            elements.closeModalBtn.addEventListener('click', closeMessageModal);
            elements.modalOverlay.addEventListener('click', closeMessageModal);
            elements.loveButton.addEventListener('click', showLoveEffect);
            elements.secretSurprise.addEventListener('click', showSecretSurprise);
            elements.printAll.addEventListener('click', printAllMessages);
            elements.themeBtn.addEventListener('click', toggleTheme);
            elements.copyBtn.addEventListener('click', copyMessage);
            elements.shareBtn.addEventListener('click', shareMessage);
            elements.saveFavoriteBtn.addEventListener('click', toggleFavorite);
            elements.nextBtn.addEventListener('click', showNextMessage);
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && elements.modal.style.display === 'flex') {
                    closeMessageModal();
                }
                if (e.key === 'ArrowRight' && elements.modal.style.display === 'flex') {
                    showNextMessage();
                }
            });
        }

        // Configurar filtros
        function setupFilters() {
            elements.filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    elements.filterButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const filter = btn.dataset.filter;
                    filterLetters(filter);
                });
            });
        }

        // Configurar b√∫squeda
        function setupSearch() {
            elements.searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                filterBySearch(searchTerm);
            });
        }

        // Filtrar cartitas
        function filterLetters(category) {
            const letters = document.querySelectorAll('.letter');
            
            letters.forEach(letter => {
                if (category === 'all' || letter.dataset.category === category) {
                    letter.style.display = 'flex';
                } else {
                    letter.style.display = 'none';
                }
            });
        }

        // Filtrar por b√∫squeda
        function filterBySearch(term) {
            const letters = document.querySelectorAll('.letter');
            
            letters.forEach(letter => {
                const day = letter.dataset.day;
                const message = messages.find(m => m.day == day);
                
                if (message.message.toLowerCase().includes(term) || term === '') {
                    letter.style.display = 'flex';
                } else {
                    letter.style.display = 'none';
                }
            });
        }

        // Abrir modal mejorado - CORREGIDO
        function openModal(day) {
            const messageData = messages.find(msg => msg.day == day);
            if (messageData) {
                state.currentDay = day;
                
                elements.modalDay.textContent = `D√≠a ${messageData.day}`;
                elements.modalMessage.textContent = messageData.message;
                elements.modalIcon.textContent = messageData.icon;
                
                // Marcar como visto
                if (!state.viewedMessages.includes(day)) {
                    state.viewedMessages.push(day);
                    localStorage.setItem('viewedMessages', JSON.stringify(state.viewedMessages));
                    updateProgress();
                }
                
                // Actualizar bot√≥n de favorito
                updateFavoriteButton(day);
                
                // Mostrar modal
                elements.modal.style.display = 'flex';
                
                updateCurrentDay(day);
                
                // Efecto de entrada
                playSound(elements.sparkleSound);
            }
        }

        // Cerrar modal - CORREGIDO
        function closeMessageModal() {
            elements.modal.style.display = 'none';
        }

        // Actualizar bot√≥n de favorito
        function updateFavoriteButton(day) {
            const isFavorite = state.favorites.includes(day);
            elements.saveFavoriteBtn.innerHTML = isFavorite ? 
                '<i class="fas fa-heart"></i>' : 
                '<i class="far fa-heart"></i>';
            elements.saveFavoriteBtn.style.color = isFavorite ? 'var(--accent-color)' : 'white';
        }

        // Alternar favorito
        function toggleFavorite() {
            const day = state.currentDay;
            const index = state.favorites.indexOf(day);
            
            if (index > -1) {
                state.favorites.splice(index, 1);
                showNotification('Eliminado de favoritos üíî');
            } else {
                state.favorites.push(day);
                showNotification('¬°A√±adido a favoritos! üíñ');
                
                // Aumentar nivel de amor
                state.loveLevel = Math.min(state.loveLevel + 5, 200);
                localStorage.setItem('loveLevel', state.loveLevel);
                elements.loveLevel.textContent = state.loveLevel + '%';
            }
            
            localStorage.setItem('favorites', JSON.stringify(state.favorites));
            updateFavoriteButton(day);
            createLetters(); // Actualizar vista
        }

        // Copiar mensaje
        function copyMessage() {
            const text = `${elements.modalMessage.textContent}\n\nD√≠a ${state.currentDay}`;
            navigator.clipboard.writeText(text)
                .then(() => showNotification('¬°Mensaje copiado! üìã'))
                .catch(err => console.error('Error al copiar:', err));
        }

        // Compartir mensaje
        function shareMessage() {
            const text = `D√≠a ${state.currentDay}: ${elements.modalMessage.textContent}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Un mensaje de amor üíå',
                    text: text,
                    url: window.location.href
                });
            } else {
                copyMessage();
            }
        }

        // Mostrar siguiente mensaje
        function showNextMessage() {
            const currentIndex = messages.findIndex(msg => msg.day == state.currentDay);
            const nextIndex = (currentIndex + 1) % messages.length;
            openModal(messages[nextIndex].day);
        }

        // Mostrar efecto de amor mejorado
        function showLoveEffect() {
            showFloatingLove();
            
            // Mostrar m√∫ltiples mensajes de amor
            const loveMessages = ["TE AMO", "ERES MI TODO", "MI CORAZ√ìN ES TUYO", "PARA SIEMPRE"];
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    showFloatingLove(loveMessages[i % loveMessages.length]);
                }, i * 300);
            }
            
            closeMessageModal();
            showNotification('¬°TE AMO M√ÅS! üíñ‚ù§Ô∏èüíï');
        }

        // Mostrar sorpresa secreta
        function showSecretSurprise() {
            // Mostrar mensaje especial
            showNotification('¬°SORPRESA! Eres el mejor regalo de mi vida üéÅüíù');
            
            // Reproducir sonido especial
            playSound(elements.sparkleSound);
            
            // Cambiar fondo temporalmente
            document.body.style.background = 'linear-gradient(135deg, #ff0080, #ff8c00, #40e0d0)';
            document.body.style.backgroundSize = '400% 400%';
            document.body.style.animation = 'gradient 10s ease infinite';
            
            setTimeout(() => {
                document.body.style.background = '';
                document.body.style.animation = '';
            }, 5000);
        }

        // Imprimir todos los mensajes
        function printAllMessages() {
            const printWindow = window.open('', '_blank');
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Mis Mensajes de Amor - Para KIM</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #ff2e63; text-align: center; }
                        .message { margin: 20px 0; padding: 15px; border-left: 5px solid #ff6b8b; }
                        .day { font-weight: bold; color: #ff2e63; }
                    </style>
                </head>
                <body>
                    <h1>üíå Mensajes de Amor para KIM üíå</h1>
                    ${messages.map(msg => `
                        <div class="message">
                            <div class="day">D√≠a ${msg.day}</div>
                            <div>${msg.icon} ${msg.message}</div>
                        </div>
                    `).join('')}
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        // Alternar tema claro/oscuro
        function toggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', state.theme);
            applyTheme();
            
            const icon = elements.themeBtn.querySelector('i');
            icon.className = state.theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
            
            showNotification(state.theme === 'light' ? 'Modo claro ‚òÄÔ∏è' : 'Modo rom√°ntico üåô');
        }

        // Aplicar tema
        function applyTheme() {
            if (state.theme === 'dark') {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }

        // Actualizar contadores
        function updateCounters() {
            elements.daysTogether.textContent = '63';
            elements.loveLevel.textContent = state.loveLevel + '%';
        }

        // Actualizar barra de progreso
        function updateProgress() {
            const totalMessages = messages.length;
            const viewedCount = state.viewedMessages.length;
            const percentage = Math.round((viewedCount / totalMessages) * 100);
            
            elements.progressBar.style.setProperty('--progress', `${percentage}%`);
            elements.progressBar.style.width = `${percentage}%`;
            elements.progressPercent.textContent = `${percentage}%`;
        }

        // Mostrar notificaci√≥n
        function showNotification(text) {
            elements.notificationText.textContent = text;
            elements.notification.classList.add('show');
            
            setTimeout(() => {
                elements.notification.classList.remove('show');
            }, 3000);
        }

        // Reproducir sonido
        function playSound(audioElement) {
            audioElement.currentTime = 0;
            audioElement.play().catch(e => console.log("Audio no pudo reproducirse:", e));
        }

        // Truncar texto
        function truncateText(text, maxLength) {
            return text.length <= maxLength ? text : text.substring(0, maxLength) + '...';
        }

        // Actualizar d√≠a actual
        function updateCurrentDay(day = 1) {
            elements.currentDayElement.textContent = day;
            state.currentDay = day;
        }

        // Mostrar mensaje flotante mejorado
        function showFloatingLove(text = "TE AMO") {
            const love = elements.floatingLove.cloneNode(true);
            love.textContent = text;
            love.style.position = 'fixed';
            love.style.left = Math.random() * 80 + 10 + '%';
            love.style.top = Math.random() * 80 + 10 + '%';
            love.style.fontSize = Math.random() * 4 + 3 + 'rem';
            love.style.color = `hsl(${Math.random() * 360}, 100%, 60%)`;
            love.style.opacity = '1';
            love.style.zIndex = '1001';
            
            document.body.appendChild(love);
            
            // Animaci√≥n
            const duration = 2000 + Math.random() * 1000;
            const animation = love.animate([
                { transform: 'translate(-50%, -50%) scale(0)', opacity: 1 },
                { transform: 'translate(-50%, -150%) scale(1.5)', opacity: 0 }
            ], {
                duration: duration,
                easing: 'cubic-bezier(0.175, 0.885, 0.32, 1.275)'
            });
            
            animation.onfinish = () => love.remove();
        }

        // Inicializar part√≠culas
        if (typeof particlesJS !== 'undefined') {
            particlesJS('particles-js', {
                particles: {
                    number: { value: 80, density: { enable: true, value_area: 800 } },
                    color: { value: "#ff6b8b" },
                    shape: { type: "circle" },
                    opacity: { value: 0.5, random: true },
                    size: { value: 3, random: true },
                    line_linked: {
                        enable: true,
                        distance: 150,
                        color: "#ffa8c2",
                        opacity: 0.4,
                        width: 1
                    },
                    move: {
                        enable: true,
                        speed: 2,
                        direction: "none",
                        random: true,
                        straight: false,
                        out_mode: "out",
                        bounce: false
                    }
                },
                interactivity: {
                    detect_on: "canvas",
                    events: {
                        onhover: { enable: true, mode: "repulse" },
                        onclick: { enable: true, mode: "push" }
                    }
                }
            });
        }
    </script>
</body>
</html>
